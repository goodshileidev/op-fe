# éƒ¨ç½²æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ¨¡å—**: éƒ¨ç½²æ–¹æ¡ˆ
- **ä¼˜å…ˆçº§**: P1
- **é¢„è®¡å·¥æ—¶**: 3-4 å·¥ä½œæ—¥
- **ä¾èµ–**: 08-backward-compatibility, 09-testing-strategy
- **è´Ÿè´£äºº**: å¾…åˆ†é…

---

## ğŸ¯ éƒ¨ç½²ç›®æ ‡

å®ç°**å®‰å…¨ã€å¯æ§çš„ç°åº¦å‘å¸ƒ**:

1. âœ… ç°åº¦å‘å¸ƒæ–¹æ¡ˆ
2. âœ… å…¨é‡å‘å¸ƒè®¡åˆ’
3. âœ… ç›‘æ§å’Œå‘Šè­¦
4. âœ… å›æ»šé¢„æ¡ˆ
5. âœ… ç”¨æˆ·åŸ¹è®­è®¡åˆ’

---

## ğŸ“… å‘å¸ƒè®¡åˆ’

### é˜¶æ®µ1: å¼€å‘ç¯å¢ƒéªŒè¯ (Week 1)

**ç›®æ ‡**: éªŒè¯åŸºç¡€åŠŸèƒ½

- [ ] éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
- [ ] åŠŸèƒ½éªŒè¯
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] Bug ä¿®å¤

### é˜¶æ®µ2: æµ‹è¯•ç¯å¢ƒéªŒè¯ (Week 2)

**ç›®æ ‡**: å®Œæ•´æµç¨‹æµ‹è¯•

- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- [ ] é›†æˆæµ‹è¯•
- [ ] E2E æµ‹è¯•
- [ ] ç”¨æˆ·éªŒæ”¶æµ‹è¯• (UAT)

### é˜¶æ®µ3: é¢„å‘å¸ƒç¯å¢ƒ (Week 3)

**ç›®æ ‡**: ç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿ

- [ ] éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
- [ ] ç”Ÿäº§æ•°æ®æµ‹è¯•
- [ ] æ€§èƒ½å‹æµ‹
- [ ] å®‰å…¨æ‰«æ

### é˜¶æ®µ4: ç°åº¦å‘å¸ƒ (Week 4)

**ç›®æ ‡**: é€æ­¥æ”¾é‡

- [ ] 10% ç”¨æˆ·ç°åº¦ (Day 1-2)
- [ ] 30% ç”¨æˆ·ç°åº¦ (Day 3-4)
- [ ] 50% ç”¨æˆ·ç°åº¦ (Day 5-6)
- [ ] 100% å…¨é‡å‘å¸ƒ (Day 7)

---

## ğŸ›ï¸ ç°åº¦å‘å¸ƒç­–ç•¥

### ç°åº¦è§„åˆ™

\`\`\`typescript
/**
 * ç°åº¦è§„åˆ™é…ç½®
 */
interface GrayReleaseRule {
  // æŒ‰ç”¨æˆ·IDç°åº¦
  userIds?: string[];
  
  // æŒ‰ç»„ç»‡ç°åº¦
  orgIds?: string[];
  
  // æŒ‰ç™¾åˆ†æ¯”ç°åº¦
  percentage?: number;
  
  // æŒ‰ç™½åå•ç°åº¦
  whitelist?: string[];
}

// ç°åº¦åˆ¤æ–­é€»è¾‘
function shouldUseNewVersion(user: User, rule: GrayReleaseRule): boolean {
  // 1. ç™½åå•ç”¨æˆ·ç›´æ¥ä½¿ç”¨æ–°ç‰ˆæœ¬
  if (rule.whitelist?.includes(user.id)) {
    return true;
  }
  
  // 2. æŒ‡å®šç”¨æˆ·åˆ—è¡¨
  if (rule.userIds?.includes(user.id)) {
    return true;
  }
  
  // 3. æŒ‡å®šç»„ç»‡
  if (rule.orgIds?.includes(user.orgId)) {
    return true;
  }
  
  // 4. æŒ‰ç™¾åˆ†æ¯”ç°åº¦
  if (rule.percentage) {
    const hash = hashCode(user.id);
    return (hash % 100) < rule.percentage;
  }
  
  return false;
}
\`\`\`

---

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### å…³é”®æŒ‡æ ‡ç›‘æ§

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|------|------|----------|
| API é”™è¯¯ç‡ | > 1% | ä¸¥é‡ |
| API å“åº”æ—¶é—´ | > 500ms | è­¦å‘Š |
| é¡µé¢åŠ è½½æ—¶é—´ | > 3s | è­¦å‘Š |
| æœåŠ¡å¯ç”¨æ€§ | < 99.5% | ä¸¥é‡ |
| æ•°æ®åº“è¿æ¥æ•° | > 80% | è­¦å‘Š |

### ç›‘æ§é…ç½®

\`\`\`yaml
# prometheus ç›‘æ§é…ç½®
groups:
  - name: api_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "API é”™è¯¯ç‡è¿‡é«˜"
          
      - alert: SlowResponse
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API å“åº”æ—¶é—´è¿‡æ…¢"
\`\`\`

---

## ğŸ”„ å›æ»šé¢„æ¡ˆ

### å›æ»šè§¦å‘æ¡ä»¶

1. **è‡´å‘½Bug** - å½±å“æ ¸å¿ƒåŠŸèƒ½
2. **æ€§èƒ½ä¸‹é™** - å“åº”æ—¶é—´ > 2å€
3. **é”™è¯¯ç‡æ¿€å¢** - é”™è¯¯ç‡ > 5%
4. **æ•°æ®ä¸ä¸€è‡´** - å‘ç°æ•°æ®é—®é¢˜

### å›æ»šæ­¥éª¤

\`\`\`bash
# 1. åœæ­¢ç°åº¦
curl -X POST http://api/admin/gray-release/stop

# 2. åˆ‡æ¢æµé‡åˆ°æ—§ç‰ˆæœ¬
curl -X POST http://api/admin/switch-version -d '{"version": "old"}'

# 3. å›æ»šæ•°æ®åº“ (å¦‚æœéœ€è¦)
mysql < scripts/rollback/rollback.sql

# 4. é‡å¯æœåŠ¡
pm2 restart all

# 5. éªŒè¯æœåŠ¡çŠ¶æ€
curl http://api/health
\`\`\`

---

## ğŸ“š ç”¨æˆ·åŸ¹è®­è®¡åˆ’

### åŸ¹è®­å†…å®¹

1. **æ–°åŠŸèƒ½ä»‹ç»** (1å°æ—¶)
   - åœºæ™¯åˆ‡æ¢åŠŸèƒ½
   - æ–°çš„è¡¨å•ç¼–è¾‘å™¨
   - æ”¹è¿›çš„æƒé™ç®¡ç†

2. **æ“ä½œæ¼”ç¤º** (2å°æ—¶)
   - åˆ›å»ºå’Œç¼–è¾‘è®°å½•
   - ä½¿ç”¨æ–°çš„å­—æ®µç±»å‹
   - é…ç½®è§„åˆ™å’Œå·¥ä½œæµ

3. **å¸¸è§é—®é¢˜** (1å°æ—¶)
   - æ•°æ®è¿ç§»è¯´æ˜
   - å…¼å®¹æ€§é—®é¢˜
   - æ•…éšœæ’æŸ¥

### åŸ¹è®­ææ–™

- [ ] ç”¨æˆ·æ‰‹å†Œ (PDF)
- [ ] è§†é¢‘æ•™ç¨‹
- [ ] åœ¨çº¿å¸®åŠ©æ–‡æ¡£
- [ ] FAQ æ–‡æ¡£

---

## âœ… å‘å¸ƒæ£€æŸ¥æ¸…å•

### å‘å¸ƒå‰æ£€æŸ¥

- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡
- [ ] å®‰å…¨æ‰«æé€šè¿‡
- [ ] æ•°æ®å¤‡ä»½å®Œæˆ
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡
- [ ] ç›‘æ§é…ç½®å®Œæˆ
- [ ] ç”¨æˆ·é€šçŸ¥å‘é€

### å‘å¸ƒåæ£€æŸ¥

- [ ] æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- [ ] å…³é”®åŠŸèƒ½å¯ç”¨
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†
- [ ] é—®é¢˜è®°å½•å’Œè¿½è¸ª

---

**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-13
